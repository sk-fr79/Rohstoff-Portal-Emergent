CREATE OR REPLACE VIEW 
S#MANDANT#_WE_RECHPOS_MONAT_SUM
(
SUM_MENGE,
SUM_ABZUG_MENGE,
SUM_GESAMTPREIS,
SUM_GPREIS_ABZUG_MGE,
SUM_GPREIS_ABZUG_AUF_NETTOMGE,
SUM_GESAMTPREIS_NETTO,
ID_ADRESSE,
LEISTUNGSDATUM_MONAT_JAHR,
ID_ARTIKEL,
LIEFERBEDINGUNGEN,
BASIS
)
AS
(
SELECT 
SUM(NVL(ANZAHL,0)) AS SUM_MENGE,
SUM(NVL(ANZAHL_ABZUG_LAGER,0)) AS SUM_ABZUG_MENGE,
SUM(NVL(GESAMTPREIS,0)) AS SUM_GESAMTPREIS,
SUM(NVL(GPREIS_ABZ_MGE,0)) AS SUM_GPREIS_ABZUG_MGE,
SUM(NVL(GPREIS_ABZ_AUF_NETTOMGE,0)) AS SUM_GPREIS_ABZUG_AUF_NETTOMGE,
SUM(NVL(GESAMTPREIS,0)-NVL(GPREIS_ABZ_MGE,0)-NVL(GPREIS_ABZ_AUF_NETTOMGE,0))  AS SUM_GESAMTPREIS_NETTO,
NVL(JT_VKOPF_RG.ID_ADRESSE,JT_VPOS_RG.ID_ADRESSE) AS ID_ADRESSE,
TO_CHAR(JT_VPOS_RG.AUSFUEHRUNGSDATUM,'YYYY-MM') AS LEISTUNGSDATUM_MONAT_JAHR,
JT_VPOS_RG.ID_ARTIKEL,
JT_VPOS_RG.LIEFERBEDINGUNGEN,
JT_VPOS_RG.BASIS
FROM 

---erweiterte RG-Tabelle
(
SELECT VP.*,
(CASE WHEN (VP.ID_VPOS_TPA_FUHRE_ZUGEORD IS NULL) THEN
'FREI'
ELSE 
'FUHRE'
END) AS BASIS
 FROM JT_VPOS_RG VP
) 
--ende eweiterte RG
JT_VPOS_RG  
  
LEFT OUTER JOIN JT_VKOPF_RG ON (JT_VPOS_RG.ID_VKOPF_RG=JT_VKOPF_RG.ID_VKOPF_RG)  
WHERE 
NVL(JT_VPOS_RG.DELETED,'N')='N' AND 
NVL(JT_VKOPF_RG.DELETED,'N')='N' AND 
JT_VPOS_RG.ID_VPOS_RG_STORNO_VORGAENGER IS NULL  AND
JT_VPOS_RG.ID_VPOS_RG_STORNO_NACHFOLGER IS NULL  AND
JT_VKOPF_RG.ID_VKOPF_RG_STORNO_VORGAENGER IS NULL  AND
JT_VKOPF_RG.ID_VKOPF_RG_STORNO_NACHFOLGER IS NULL  AND
JT_VPOS_RG.LAGER_VORZEICHEN = 1 AND 
JT_VPOS_RG.ID_MANDANT=#MANDANT#
GROUP BY 
NVL(JT_VKOPF_RG.ID_ADRESSE,JT_VPOS_RG.ID_ADRESSE),
TO_CHAR(JT_VPOS_RG.AUSFUEHRUNGSDATUM,'YYYY-MM'),
JT_VPOS_RG.ID_ARTIKEL,
JT_VPOS_RG.LIEFERBEDINGUNGEN,
JT_VPOS_RG.BASIS
)

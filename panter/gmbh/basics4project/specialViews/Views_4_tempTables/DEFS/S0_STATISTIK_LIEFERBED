CREATE OR REPLACE VIEW 
S#MANDANT#_STATISTIK_LIEFERBED
(
ANZAHL,
ID_ADRESSE,
LIEFERBED,
LAGER_VORZEICHEN
)
AS 
(
SELECT COUNT(*) AS ANZAHL, ID_ADRESSE, LIEFERBED, LAGER_VORZEICHEN 
FROM
(
select 
NVL(RK.ID_ADRESSE,RP.ID_ADRESSE) AS ID_ADRESSE
,  CASE WHEN RP.LAGER_VORZEICHEN=1 THEN
       UPPER(SUBSTR( NVL(NVL(FUO.LIEFERBED_ALTERNATIV,NVL(FU.LIEFERBED_ALTERNATIV_EK,RP.LIEFERBEDINGUNGEN)),'---')||'---',1,3)) 
   ELSE
        UPPER(SUBSTR( NVL(NVL(FUO.LIEFERBED_ALTERNATIV,NVL(FU.LIEFERBED_ALTERNATIV_VK,RP.LIEFERBEDINGUNGEN)),'---')||'---',1,3)) 
   END AS LIEFERBED
, RP.LAGER_VORZEICHEN

FROM 
JT_VPOS_RG  RP  
LEFT OUTER JOIN JT_VKOPF_RG RK  ON (RP.ID_VKOPF_RG=RK.ID_VKOPF_RG)
LEFT OUTER JOIN JT_VPOS_TPA_FUHRE_ORT FUO ON (RP.ID_VPOS_TPA_FUHRE_ORT_ZUGEORD=FUO.ID_VPOS_TPA_FUHRE_ORT)
LEFT OUTER JOIN JT_VPOS_TPA_FUHRE FU ON (RP.ID_VPOS_TPA_FUHRE_ZUGEORD=FU.ID_VPOS_TPA_FUHRE)
WHERE RP.ID_VPOS_RG_STORNO_VORGAENGER IS NULL
AND   RP.ID_VPOS_RG_STORNO_NACHFOLGER IS NULL
AND NVL(RP.DELETED,'N')='N'
AND NVL(RK.DELETED,'N')='N'
AND  RP.ID_MANDANT=1
)
GROUP BY ID_ADRESSE, LIEFERBED,LAGER_VORZEICHEN
)

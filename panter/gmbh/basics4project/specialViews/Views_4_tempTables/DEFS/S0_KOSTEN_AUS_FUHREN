CREATE OR REPLACE VIEW 
S#MANDANT#_KOSTEN_AUS_FUHREN 
AS 
SELECT *
FROM 
(


SELECT 
FU.ID_ADRESSE_LAGER_START,
FU.ID_ADRESSE_LAGER_ZIEL,
ART.ID_ARTIKEL,
EH.ID_EINHEIT AS ID_EINHEIT_MENGE,
EH.EINHEITKURZ AS EINHEIT_MENGE,
EHP.ID_EINHEIT AS ID_EINHEIT_PREIS,
EHP.EINHEITKURZ AS EINHEIT_PREIS,
ART.MENGENDIVISOR,
FU.STATUS_BUCHUNG,
FU.ID_VPOS_TPA_FUHRE,
FU.ANTEIL_LADEMENGE_LIEF,
TO_CHAR(NVL(FU.DATUM_AUFLADEN,FU.DATUM_ABHOLUNG),'YYYY-MM-DD') AS DATUM,
SUM(
CASE WHEN KT.ID_FUHREN_KOSTEN_TYP IS NULL THEN 
   ROUND(KO.BETRAG_KOSTEN/(FU.ANTEIL_LADEMENGE_LIEF/ART.MENGENDIVISOR),2)
ELSE 0   
END) AS TP_KOST_PRO_ABRECH_EH_UDEF,

SUM(
CASE WHEN  KT.ID_FUHREN_KOSTEN_TYP IS NOT NULL AND NVL(KT.NEUTRAL,'N')='N' THEN 
   ROUND(KO.BETRAG_KOSTEN/(FU.ANTEIL_LADEMENGE_LIEF/ART.MENGENDIVISOR),2)
ELSE 0   
END) AS TP_KOST_PRO_ABRECH_EH_REAL,

SUM(
CASE WHEN   KT.ID_FUHREN_KOSTEN_TYP IS NOT NULL AND  NVL(KT.NEUTRAL,'N')='Y' THEN 
   ROUND(KO.BETRAG_KOSTEN/(FU.ANTEIL_LADEMENGE_LIEF/ART.MENGENDIVISOR),2)
ELSE 0   
END) AS TP_KOST_PRO_ABRECH_EH_NEUTRAL


FROM    JT_VPOS_TPA_FUHRE FU 
INNER JOIN JT_ARTIKEL_BEZ AB ON (AB.ID_ARTIKEL_BEZ=FU.ID_ARTIKEL_BEZ_EK)
INNER JOIN JT_ARTIKEL ART ON (AB.ID_ARTIKEL=ART.ID_ARTIKEL)
INNER JOIN JT_VPOS_TPA_FUHRE_KOSTEN KO ON (FU.ID_VPOS_TPA_FUHRE=KO.ID_VPOS_TPA_FUHRE)
INNER JOIN JT_EINHEIT EH ON (ART.ID_EINHEIT=EH.ID_EINHEIT)
INNER JOIN JT_EINHEIT EHP ON (ART.ID_EINHEIT_PREIS=EHP.ID_EINHEIT)
LEFT OUTER JOIN  JT_FUHREN_KOSTEN_TYP KT ON (KO.ID_FUHREN_KOSTEN_TYP=KT.ID_FUHREN_KOSTEN_TYP)
WHERE NVL(FU.DELETED,'N')='N'
AND NVL(FU.IST_STORNIERT,'N')='N'
AND NVL(FU.ANTEIL_LADEMENGE_LIEF,0)>0
AND ((SELECT COUNT(*) FROM JT_VPOS_TPA_FUHRE_ORT FO WHERE NVL(FO.DELETED,'N')='N' AND FO.ID_VPOS_TPA_FUHRE=FU.ID_VPOS_TPA_FUHRE)=0)
AND FU.ID_MANDANT=#MANDANT#
GROUP BY 
FU.ID_ADRESSE_LAGER_START,
FU.ID_ADRESSE_LAGER_ZIEL,
ART.ID_ARTIKEL,
EH.ID_EINHEIT,
EH.EINHEITKURZ,
EHP.ID_EINHEIT,
EHP.EINHEITKURZ,
ART.MENGENDIVISOR,
FU.STATUS_BUCHUNG,
FU.ID_VPOS_TPA_FUHRE,
FU.ANTEIL_LADEMENGE_LIEF,
TO_CHAR(NVL(FU.DATUM_AUFLADEN,FU.DATUM_ABHOLUNG),'YYYY-MM-DD')

)
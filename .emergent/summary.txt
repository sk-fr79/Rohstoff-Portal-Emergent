<analysis>**original_problem_statement:**
Der Benutzer möchte eine veraltete Java/Echo2-Anwendung namens Rohstoff Portal modernisieren. Das Ziel ist eine neue Architektur mit einem FastAPI/Python-Backend, einer PostgreSQL-Datenbank (aktuell MongoDB) und einem modernen React PWA-Frontend. Die gesamte Geschäftslogik der bestehenden Anwendung muss 1:1 übernommen werden.

Die jüngste und wichtigste Anforderung (P0) ist die vollständige Neugestaltung und Implementierung des **Kreditversicherungs-Moduls**. Die erste Implementierung war unzureichend. Der Benutzer hat detaillierte Anforderungen und Screenshots aus dem Altsystem bereitgestellt, die Folgendes umfassen:
-   Eine zweistufige Struktur: Ein **Generalversicherungsvertrag (Kopf)** mit einem Gesamtlimit und einer globalen Gültigkeit.
-   Darunter liegende **Kundenpositionen**, bei denen jeder Kunde ein eigenes Limit, eine eigene Unterversicherungsnummer, eine Fakturierungsfrist und eine Gültigkeitsdauer erhält.
-   Die **Auslastung** der Hauptversicherung wird in Prozent angezeigt (Summe der Kundenlimits / Gesamtlimit).
-   Die Kundenliste innerhalb einer Versicherung soll als smarte Grid-Tabelle mit Suchfunktion dargestellt werden.
-   Die Kreditlimit-Daten sollen in den Adress-Stammdaten sichtbar sein und die **Sperrlogik im Fuhren-Modul** bei Limitüberschreitung steuern.

**User's preferred language**: German

**what currently exists?**
-   Ein modular aufgebautes FastAPI-Backend und ein React PWA-Frontend.
-   Alle Kernmodule (, , , , , ) sind implementiert.
-   Das **Adressformular** wurde erfolgreich überarbeitet, inklusive dynamischer Felder (Firma/Privat) und korrekter Anzeige von Länderflaggen (SVG-Icons). Die Geschäftslogik aus dem Echo2-System (z.B. Steuer-Validierung) wurde ins Backend integriert.
-   An die Adress-Detailseite wurden **Tabs für Bankverbindungen und Lieferadressen** angebunden, inklusive funktionierender Backend-Endpunkte.
-   Eine erste, einfache Version des **Kreditversicherungs-Moduls** wurde erstellt (eigener Menüpunkt, Backend-Router, Tab in der Adress-Detailansicht). Diese Version ist jedoch unzureichend und muss gemäß den neuen, detaillierten Anforderungen des Benutzers komplett überarbeitet werden.

**Last working item**:
-   **Last item agent was working:** Analyse der detaillierten Anforderungen für die Neugestaltung des Kreditversicherungs-Moduls, basierend auf den vom Benutzer bereitgestellten Screenshots und Beschreibungen. Die Analyse der Bilder und die Erstellung eines Migrations-Analyse-Dokuments ist abgeschlossen. Die eigentliche Implementierung der neuen Logik hat noch nicht begonnen.
-   **Status:** IN PROGRESS
-   **Agent Testing Done:** N (für die neuen, detaillierten Anforderungen)
-   **Which testing method agent to use?** both.
    -   **Backend testing agent:** Zum Testen der neuen, komplexen Datenmodelle (Kopf/Positionen), der CRUD-Endpunkte und der Auslastungsberechnungslogik.
    -   **Frontend testing agent:** Zum Testen der neuen Verwaltungsseite, der Grid-Tabelle mit Suche, der Formulare zur Erstellung/Bearbeitung und der korrekten Anzeige der Auslastung.
-   **User Testing Done:** N

**All Pending/In progress Issue list**:
-   **Issue 1: (P0) Komplette Neugestaltung des Kreditversicherungs-Moduls**
    -   **Attempted fixes:** Eine Basisversion wurde implementiert, die aber vom Benutzer als unzureichend eingestuft wurde, da die komplexe Kopf/Positions-Struktur und die Geschäftslogik fehlten.
    -   **Next debug checklist:**
        1.  **Backend-Modelle überarbeiten:** In  die Pydantic-Modelle anpassen, um die hierarchische Struktur ( mit einer Liste von ) abzubilden.
        2.  **Backend-API anpassen:** CRUD-Endpunkte für den  und die untergeordneten  (z.B. ) implementieren.
        3.  **Backend-Logik implementieren:** Eine Funktion oder einen virtuellen Getter erstellen, der die prozentuale Auslastung des Gesamtlimits berechnet.
        4.  **Frontend-Seite () umbauen:** Die Seite muss eine Liste der Generalversicherungsverträge anzeigen und eine Detailansicht für einen ausgewählten Vertrag bieten.
        5.  **Frontend-Grid implementieren:** In der Detailansicht eine smarte Grid-Tabelle (z.B. mit ) für die Kundenpositionen erstellen, inklusive einer Suchleiste.
        6.  **Frontend-Formulare erstellen:** Modale Dialoge oder Sidebars zum Erstellen/Bearbeiten von Hauptverträgen und Kundenpositionen implementieren.
        7.  **Sperrlogik integrieren:** Die Kreditlimitprüfung im -Modul implementieren.
    -   **Why fix this issue and what will be achieved with the fix?** Dies ist eine geschäftskritische Kernfunktion zur Steuerung des Kreditrisikos und wurde vom Benutzer mit höchster Priorität angefordert.
    -   **Status:** IN PROGRESS
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** both
    -   **Blocked on other issue:** None

**In progress Task List**:
-   **Task 1: (P0) Implementierung der detaillierten Kreditversicherungs-Verwaltung**
    -   **Where to resume:** Die Analyse ist abgeschlossen. Der nächste Schritt ist die Implementierung der neuen Backend-Datenmodelle in  und den zugehörigen API-Endpunkten.
    -   **What will be achieved with this?** Ein voll funktionsfähiges Modul zur Verwaltung von Kreditversicherungen gemäß den detaillierten Spezifikationen des Benutzers.
    -   **Status:** IN PROGRESS
    -   **Should Test frontend/backend/both after fix?** both
    -   **Blocked on something:** None

**Upcoming and Future Tasks**
-   **Upcoming Tasks:**
    -   **PDF-Export (P1):** Implementierung der PDF-Erstellung für Rechnungen und Lieferscheine.
    -   **Sammelrechnungen (P2):** Funktion implementieren, mit der mehrere Fuhren zu einer einzigen Sammelrechnung zusammengefasst werden können.
    -   **Integration der Kreditlimit-Sperrlogik (P2):** Prüfung des Kreditlimits bei der Erstellung von  und Anzeige von Warnungen/Blockaden.

-   **Future Tasks:**
    -   Datenimport aus dem Altsystem.
    -   Vollständige PWA-Funktionen (Offline-Fähigkeit).
    -   Umfassendes Unit- und E2E-Testing für alle Module.
    -   Fertigstellung der Dokumentation.

**Completed work in this session**
-   **Adressformular-Redesign (FERTIG):** Die Anzeige von Länderflaggen wurde von fehlerhaften Emojis auf SVG-Icons () umgestellt und die Funktionalität (Privat/Firma-Toggle, umbenannte Felder) wurde per Testing-Agent vollständig verifiziert.
-   **Echo2-Logik-Migration (FERTIG):** Wichtige Geschäftslogik (z.B. Steuer-Validierung, Pflichtfelder, Default-Werte für Sperren) wurde aus dem alten Java-Code analysiert und in das FastAPI-Backend ( und ) implementiert und getestet.
-   **Adressen-Erweiterung (FERTIG):** Tabs und CRUD-Funktionalität für **Bankverbindungen** und **Lieferadressen** wurden im Frontend und Backend implementiert. Eine Komponente zur Anzeige von Validierungsfehlern () wurde hinzugefügt.
-   **Kreditversicherungs-Analyse (FERTIG):** Eine detaillierte Analyse des Echo2-Codes für die Kreditversicherungs-Logik wurde durchgeführt und in  dokumentiert.

**Earlier issues found/mentioned but not fixed**
-   Keine.

**Known issue recurrence from previous fork**
-   Keine.

**Code Architecture**


**Key Technical Concepts**
-   **Backend:** FastAPI, Pydantic, MongoDB (), modulare Router-Architektur.
-   **Frontend:** React, TypeScript, Vite, TailwindCSS, shadcn/ui, Zustand, , .
-   **Neu Hinzugefügt:**  für die Flaggenanzeige im Frontend.

**key DB schema**
-   **adressen:** Haupt-Collection für Adress-Stammdaten.
-   **bankverbindungen, lieferadressen:** Werden als eingebettete Dokumente in  oder als separate Collections mit Referenz zur  gespeichert (der Agent hat CRUD-Endpunkte unter  erstellt, was eine Referenzbeziehung impliziert).
-   **kreditversicherungen:** Neue Collection, die überarbeitet werden muss, um eine Kopf-Dokument mit einer Liste von eingebetteten Kundenpositions-Dokumenten zu speichern.

**changes in tech stack**
-   Frontend-Abhängigkeit  wurde via yarn install v1.22.22
info No lockfile found.
[1/4] Resolving packages...
[2/4] Fetching packages...
[3/4] Linking dependencies...
[4/4] Building fresh packages...
success Saved lockfile.
Done in 0.02s. hinzugefügt.

**All files of reference**
-   **/app/backend/routers/kreditversicherung.py**: Neu erstellt, muss aber grundlegend überarbeitet werden.
-   **/app/frontend/src/features/kreditversicherungen/KreditversicherungenPage.tsx**: Neu erstellt, muss grundlegend überarbeitet werden.
-   **/app/frontend/src/features/adressen/AdressenPage.tsx**: Stark modifiziert, um neue Tabs, Komponenten und Validierungslogik zu integrieren.
-   **/app/backend/routers/adressen.py**: Erweitert um neue Endpunkte für Bankverbindungen/Lieferadressen und eine stark verbesserte Validierungslogik.
-   **/app/backend/services/validation.py**: Erweitert um die Geschäftslogik aus dem Echo2-System.
-   **/app/frontend/src/features/adressen/components/**: Neue Komponenten für die Tabs und die Validierungsanzeige.
-   **/app/memory/MIGRATION_ANALYSE_KREDITVERSICHERUNG.md**: Neue Analyse-Datei mit den Details zur Implementierung.
-   **/app/memory/PRD.md**: Aktualisiert mit den abgeschlossenen und neuen Aufgaben.

**Areas that need refactoring**:
-   Die Datei  ist mit über 2000 Zeilen extrem groß geworden. Auch wenn neue Tabs in Komponenten ausgelagert wurden, ist die Hauptdatei ein Kandidat für weiteres Refactoring, um die Logik (Datenabruf, Zustandsverwaltung, Formular-Handler) besser zu strukturieren.

**key api endpoints**
-    (CRUD)
-    (CRUD)
-    (CRUD - **muss für die neue Kopf/Positions-Struktur komplett überarbeitet werden**)

**Critical Info for New Agent**
-   **Ihre absolute Top-Priorität (P0) ist die vollständige Neugestaltung des Kreditversicherungs-Moduls.** Ignorieren Sie die bisherige Implementierung und richten Sie sich ausschließlich nach den neuen, detaillierten Anforderungen des Benutzers und der Analyse in .
-   Beginnen Sie mit der Überarbeitung des **Backends**: Definieren Sie zuerst die neuen Pydantic-Modelle für die Kopf/Positions-Struktur in .
-   Implementieren Sie danach die neuen API-Endpunkte für die hierarchische Verwaltung.
-   Erst wenn das Backend steht, beginnen Sie mit dem Umbau des Frontends (), um die neue Grid-Tabelle und die Formulare zu erstellen.
-    ist sehr groß; gehen Sie bei Änderungen dort behutsam vor.

**documents and test reports created in this job**
-   
-   
-    (aktualisiert)
-   
-   
-   
-   

**Last 10 User Messages and any pending HUMAN messages**
1.  **User (latest):** Beschreibt detailliert die Anforderungen an das Kreditversicherungs-Modul, einschließlich der Kopf/Kunden-Struktur, Gesamt- vs. Einzellimits, Auslastungsberechnung und UI-Elemente, und stellt Screenshots aus dem Altsystem bereit.
2.  **Agent:** Schlägt die Implementierung der Kreditversicherungs-Verwaltung vor.
3.  **User:** Fordert die Implementierung des Kreditversicherungs-Moduls (P2-Aufgabe).
4.  **Agent:** Schließt die Implementierung von Bankverbindungen & Lieferadressen ab und schlägt die Implementierung des Artikel-Moduls vor.
5.  **User:** Fordert die Implementierung von Bankverbindungen, Lieferadressen und einer besseren Validierungsanzeige.
6.  **Agent:** Schließt die Implementierung der Echo2-Steuerlogik ab und schlägt die Implementierung des Bankverbindungen-Moduls vor.
7.  **User:** Fordert die Implementierung der P0-Aufgaben aus der Migrationsanalyse (Steuer-Logik, Default-Werte).
8.  **Agent:** Schließt die Analyse des Echo2 -Codes ab und präsentiert die Ergebnisse und P0-Aufgaben.
9.  **User:** Startet die Anforderung zur Analyse der Legacy-Java-Anwendung  für die Migration fehlender Features.
10. **Agent:** Schließt das Redesign des Adressformulars ab und schlägt als Verbesserung den PDF-Export vor.

**Project Health Check:**
-   **Broken:** Das -Modul ist funktional unvollständig und erfüllt nicht die Benutzeranforderungen. Es erfordert eine vollständige Neuentwicklung der Geschäftslogik und der Benutzeroberfläche.
-   **Mocked:** Keine.

**3rd Party Integrations**
-   **emergentintegrations:** Wird für die OCR-Funktionalität verwendet (nutzt ).
-   **EU VIES VAT Validation API:** Externe REST-API zur Validierung von Umsatzsteuer-IDs.
-   **country-flag-icons:** Frontend-Bibliothek zur Anzeige von SVG-Länderflaggen.

**Testing status**
-   **Testing agent used after significant changes:** YES. Der Testing-Agent wurde mehrfach und erfolgreich für Backend-Logik, Frontend-UI und die Behebung von Fehlern eingesetzt.
-   **Troubleshoot agent used after agent stuck in loop:** NO
-   **Test files created:**
    -   
    -   
    -   
    -   
-   **Known regressions:** Keine. Der Testing Agent hat während der Entwicklung Regressionen gefunden und behoben (z.B. fehlendes -Präfix in einem Router).

**Credentials to test flow:**
-   **Benutzername:** 
-   **Passwort:** 

**What agent forgot to execute**
-   Der Agent hat die Implementierung des Kreditversicherungs-Moduls nicht vergessen, wurde aber durch das Ende der Sitzung unterbrochen, direkt nachdem der Benutzer die detaillierten Anforderungen spezifiziert hatte. Die Aufgabe ist also bekannt und als nächster Schritt klar definiert.</analysis>

<analysis>**original_problem_statement:**
Der Benutzer möchte eine veraltete Java/Echo2-Anwendung namens Rohstoff Portal modernisieren. Das Ziel ist eine neue Architektur mit einem FastAPI/Python-Backend, einer PostgreSQL-Datenbank (aktuell MongoDB) und einem modernen React PWA-Frontend.

Die jüngsten Anforderungen konzentrieren sich auf die massive Erweiterung und Neugestaltung des **Kontrakt-Moduls**:
1.  **Neugestaltung der Vertragspartner-Sektion:** Der Benutzer war mit dem Layout unzufrieden und forderte ein kompakteres, moderneres smartes Design. Dies umfasste die Auswahl von USt-IDs und Bankverbindungen direkt aus den Stammdaten des Partners.
2.  **Lager-Logik:** Felder aus dem Termine-Reiter sollten in die Kopfdaten verschoben werden. Ein neuer Reiter Läger sollte hinzugefügt werden, um ein Abhol- und Ziellager aus den Adress-Stammdaten (inkl. Lieferadressen) des Partners auszuwählen. Die Logik sollte zwischen Einkaufs- (EK) und Verkaufskontrakten (VK) unterscheiden.
3.  **Zentrale Firmeneinstellungen:** Eine neue Seite in der Administration, um eine Adresse aus den Stammdaten als Haupt-Mandantenadresse zu definieren. Diese Adresse soll dann als Eigenes Lager im Kontraktmodul referenziert werden.
4.  **(Aktuell)** **Neugestaltung der Positionserfassung:** Der Benutzer fordert eine komplette Überarbeitung der Erfassung von Kontraktpositionen:
    *   Ein neues, smartes Design für das Position hinzufügen/bearbeiten-Formular.
    *   Eine moderne Artikelauswahl mit Filterung aus den Artikelstammdaten.
    *   Eine Funktion zum Kopieren bestehender Positionen.
    *   Eine verbesserte, informativere Übersicht der Positionen direkt im Kontrakt (Menge, Preis, Gesamt, etc.).
    *   Die Möglichkeit, Positionsdetails per Doppelklick auch im Lesemodus des Kontrakts zu öffnen.

**User's preferred language**: German

**what currently exists?**
*   Ein voll funktionsfähiges, rollenbasiertes Zugriffskontrollsystem (RBAC) und ein Einstellungen-Bereich.
*   **Abgeschlossen:** Das dynamische Nummernkreis-System ist implementiert und im Kontraktmodul integriert. Die Verwaltungsseite ist in die Einstellungen eingebunden.
*   **Abgeschlossen (Major Redesign):** Die Vertragspartner-Sektion im Kontraktmodul wurde komplett überarbeitet. Sie verwendet nun ein kompaktes, kartenbasiertes Design. Die Auswahl von USt-IDs und Bankverbindungen aus den Stammdaten des Partners ist implementiert, inklusive automatischer Vorauswahl der Haupt-ID/des Hauptkontos.
*   **Abgeschlossen:** Die Logik für Läger (Abhol-/Ziellager) ist im Kontraktmodul implementiert. Die UI wurde entsprechend angepasst (Reiter Termine entfernt, Reiter Läger hinzugefügt).
*   **Abgeschlossen:** Eine neue Seite Firmeneinstellungen unter Administration wurde erstellt. Hier kann eine Adresse als Haupt-Mandant definiert werden. Diese Adresse wird nun als Eigenes Lager im Kontraktmodul verwendet. Das zugehörige Backend () wurde erstellt.
*   **In Arbeit:** Für die Neugestaltung der Positionserfassung wurde ein neuer Backend-Endpunkt  zur gefilterten Artikelsuche erstellt. Die Frontend-Implementierung hat noch nicht begonnen.
*   Mehrere vom Benutzer gemeldete Bugs bezüglich der Datenanzeige und -speicherung im Kontraktmodul wurden behoben (z.B. Anzeige von Ansprechpartner/USt-ID/Bankverbindung nach dem Speichern und im Editiermodus).

**Last working item**:
-   **Last item agent was working:** Beginn der Implementierung für die Neugestaltung der Kontrakt-Positionserfassung. Der Agent hat den Backend-Endpunkt  erstellt, der das Filtern von Artikeln nach Gruppe und Klassifizierung ermöglicht. Der nächste Schritt ist die Neugestaltung der Frontend-Komponenten.
-   **Status:** IN PROGRESS
-   **Agent Testing Done:** N
-   **Which testing method agent to use?** both. Dies ist eine umfassende UI/UX- und Funktionsänderung. Frontend-Tests sind entscheidend für das neue Dialog- und Listendesign. Backend-Tests müssen die neue Artikelsuche validieren.
-   **User Testing Done:** N

**All Pending/In progress Issue list**:
-   **Issue 1: (P0) Neugestaltung der Kontrakt-Positionserfassung**
    -   **Attempted fixes:** Ein Backend-Endpunkt () zur Artikelsuche wurde in  erstellt.
    -   **Next debug checklist:**
        1.  **Positionen-Übersicht neu gestalten:** Die aktuelle Tabellenansicht in  ersetzen durch eine Liste, die die geforderten Felder (Menge, Preis/Einheit, Gesamtpreis, Artikelbez., Artikel-Nr.) anzeigt.
        2.  **Kopier-Funktion implementieren:** Einen Button zum Duplizieren einer vorhandenen Position hinzufügen.
        3.  **Neuen Position-Dialog erstellen:** Den bestehenden  durch ein neues, smartes und modernes Formular ersetzen.
        4.  **Artikelauswahl-Komponente integrieren:** Eine neue Komponente erstellen, die den -Endpunkt mit Filteroptionen (Artikelgruppe, Klassifizierung) nutzt.
        5.  **Detailansicht via Doppelklick:** Implementieren, dass ein Doppelklick auf eine Position (auch im Lesemodus) den Detaildialog öffnet.
    -   **Why fix this issue and what will be achieved with the fix?** Dies ist eine zentrale Anforderung des Benutzers zur Verbesserung der Benutzerfreundlichkeit und Effizienz bei der Erfassung von Kontrakten.
    -   **Status:** IN PROGRESS
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** both
    -   **Blocked on other issue:** None
-   **Issue 2: (P2) Verifizierung des Bugfixes für die Profilspeicherung**
    -   **Attempted fixes:** In einer früheren Sitzung wurde ein -Fehler beim Speichern des Benutzerprofils behoben.
    -   **Next debug checklist:** Bitten Sie den Benutzer zu bestätigen, dass das Speichern von Profiländerungen jetzt ohne Fehler funktioniert.
    -   **Why fix this issue and what will be achieved with the fix?** Dies schließt einen vom Benutzer gemeldeten kritischen Fehler ab.
    -   **Status:** USER VERIFICATION PENDING
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** N/A
    -   **Blocked on other issue:** None

**In progress Task List**:
-   Keine, die Hauptaufgabe ist unter All Pending/In progress Issue list aufgeführt.

**Upcoming and Future Tasks**
-   **Upcoming Tasks:**
    -   **(P1) Nummernkreis-System ausrollen:** Das neue System auf andere Module (Rechnungen, Lieferscheine etc.) anwenden.
    -   **(P1) Fixierungsmodul implementieren:** Ein dediziertes Modul zur Verwaltung von Fixierungen.
    -   **(P1) API-System Phase 7:** Implementierung von Import/Export und Audit-Logs für Referenztabellen.
    -   **(P2) PDF-Export:** Implementierung der PDF-Erstellung für Kontrakte, Rechnungen und Lieferscheine.
    -   **(P2) Sammelrechnungen:** Funktion implementieren, mit der mehrere Fuhren zu einer einzigen Sammelrechnung zusammengefasst werden können.
-   **Future Tasks:**
    -   Datenimport aus dem Altsystem.
    -   Vollständige PWA-Funktionen (Offline-Fähigkeit).
    -   Umfassendes Unit- und E2E-Testing für alle Module.

**Completed work in this session**
-   **Nummernkreis-System Fertigstellung:** Integration der  in die Navigation und erfolgreicher E2E-Test. Ein Bug im Backend-Datenbankcheck () wurde vom Testing-Agent behoben.
-   **Vertragspartner-Sektion Redesign:** Komplette Neugestaltung der UI im Kontrakt-Formular zu einem kompakten, kartenbasierten Layout. Inklusive Auswahl für USt-IDs und Bankverbindungen.
-   **Lager-Logik Implementierung:** Die Termine-Felder wurden in die Kopfdaten verschoben und ein neuer Läger-Reiter wurde erstellt, um Abhol- und Ziellager basierend auf Partner- und Mandantendaten auszuwählen.
-   **Firmeneinstellungen (Mandant):** Neue Backend-Route () und Frontend-Seite () zur Definition einer zentralen Firmenadresse, die von anderen Modulen (z.B. Kontrakte für Eigenes Lager) genutzt wird.
-   **Bugfixes im Kontrakt-Modul:**
    -   Behebung eines Absturzes bei der Auswahl von Partnern mit leeren USt-ID-Einträgen.
    -   Sicherstellung, dass Partnerdaten (USt-ID, Bankverbindung) und Ansprechpartner nach dem Speichern und erneuten Öffnen eines Kontrakts korrekt angezeigt und im Editiermodus bearbeitbar sind.
    -   Korrektur der Backend-Schemata (, ), um das Speichern von Bankverbindungs- und Lager-Informationen zu ermöglichen.
    -   Korrektur des Backend-Lookups, um eingebettete Bankverbindungen und Lieferadressen aus der Adressen-Collection zu laden.

**Earlier issues found/mentioned but not fixed**
-   Diverse TypeScript-Warnungen in verschiedenen, nicht direkt bearbeiteten Dateien.
-   Ein Layout-Problem in , bei dem das Scrollen bei vielen Einträgen nicht korrekt funktioniert.

**Known issue recurrence from previous fork**
-   Keine.

**Code Architecture**


**Key Technical Concepts**
-   **Dynamisches Nummernkreis-System:** Ein zentralisiertes Backend-System zur Verwaltung sequentieller Belegnummern.
-   **Kompaktes Card-UI:** Umstellung von großen Formularbereichen auf modulare, kartenbasierte Ansichten, um die Informationsdichte zu erhöhen und das Scrollen zu reduzieren (siehe Vertragspartner, Läger).
-   **Zentrale Firmeneinstellungen (Mandant):** Ein neues Singleton-Muster im Backend (), um eine zentrale Firmenadresse zu speichern, die von anderen Modulen referenziert werden kann. Dies entkoppelt die Mandantendaten von hartcodierten Werten.
-   **Dynamische Lookups:** Starke Nutzung von Backend-Lookups, um Stammdaten (Benutzer, Adressen, Artikel) dynamisch in Dropdowns und Auswahlkomponenten zu laden und zu verknüpfen.

**key DB schema**
-   **kontrakte:** (Collection ) **STARK MODIFIZIERT** - Erweitert um Felder für die Speicherung von ausgewählten Bankverbindungen und Lageradressen: , , , , , , , .
-   **adressen:** (Collection ) Das Feld  wurde implizit hinzugefügt, um die als Mandant definierte Adresse zu markieren.
-   **firma_settings:** (Neue Collection) Speichert die ID der als Firmenadresse ausgewählten Adresse. Schema: .

**changes in tech stack**
-   Keine.

**All files of reference**
-   : Die zentrale Datei für das Kontraktmodul, die massiv überarbeitet wurde.
-   : Das zugehörige Backend, das um Lookups und neue Felder erweitert wurde.
-   : Neue UI zur Verwaltung der Mandanten-Adresse.
-   : Neues Backend zur Verwaltung der Mandanten-Adresse.
-   : Erweitert um einen  Endpunkt.
-   : Angepasst, um ein Stern-Symbol für die Firmenadresse anzuzeigen.

**Areas that need refactoring**:
-   Das neue -System sollte nach Abschluss der Implementierung auf andere Module (z.B. Rechnungen) ausgerollt werden, um dortige Nummerierungslogiken zu ersetzen.
-   Die bekannten TypeScript-Warnungen und das Scroll-Problem in  sind weiterhin offen.

**key api endpoints**
-   : Neue CRUD-Endpunkte für die Firmeneinstellungen.
-   : Neuer Endpunkt, um die definierte Firmenadresse (Mandant) abzurufen.
-   : Neuer Endpunkt zur gefilterten Suche von Artikeln.
-   : Modifiziert, um nun auch  zurückzugeben.
-   : Modifiziert, um die neuen Felder für Bankverbindungen und Läger zu speichern.

**Critical Info for New Agent**
-   Ihre unmittelbare Aufgabe ist die **vollständige Neugestaltung der Positionserfassung im Kontraktmodul**, wie in All Pending/In progress Issue list beschrieben. Beginnen Sie mit dem Frontend.
-   Der Benutzer legt extrem hohen Wert auf **smarte, moderne und kompakte UI/UX**. Orientieren Sie sich am kürzlich umgesetzten Design der Vertragspartner- und Läger-Sektionen (kartenbasiert, wenig Scrollen, klare Informationen).
-   Die Logik für die Artikelauswahl muss eine **Filterung nach Artikelgruppe und Klassifizierungen** unterstützen. Der Backend-Endpunkt dafür existiert bereits.
-   Achten Sie darauf, dass alle neuen Funktionen (Kopieren, Detailansicht per Doppelklick) sowohl im **Neu- als auch im Bearbeitungs-/Lesemodus** eines Kontrakts funktionieren.

**documents and test reports created in this job**
-    (mehrfach aktualisiert)
-   

**Last 10 User Messages and any pending HUMAN messages**
-   10. **(IN PROGRESS)** Fordert eine komplette Neugestaltung der Kontrakt-Positionserfassung mit 4 Kernanforderungen: neues Design, Artikelauswahl mit Filter, Positionen kopieren, verbesserte Übersicht und Detailansicht per Doppelklick.
-   9. **(RESOLVED)** Meldet, dass Läger- und Bankverbindungs-Auswahlen nach dem Verlassen der Maske nicht gespeichert werden. Agent hat das Backend-Schema korrigiert und die Funktion verifiziert.
-   8. **(IN PROGRESS)** Fordert die Erstellung einer zentralen Firmeneinstellungen-Seite, um eine Mandantenadresse zu definieren, die vom Kontraktmodul als Eigenes Lager verwendet wird.
-   7. **(IN PROGRESS)** Fordert, den Termine-Reiter in Kopfdaten zu verschieben und einen neuen Läger-Reiter für Abhol-/Ziellager zu erstellen.
-   6. **(RESOLVED)** Meldet 3 Bugs nach dem Redesign: 1) Keine Ansprechpartner wird fälschlich angezeigt, 2) USt-ID/Bankverbindung fehlen nach dem Speichern, 3) Ansprechpartner nicht änderbar. Agent hat alle 3 Bugs behoben.
-   5. **(RESOLVED)** Meldet einen Crash bei der Auswahl des Kunden Constellium, vermutlich wegen mehrerer USt-IDs. Agent hat das Frontend-Filtering korrigiert.
-   4. **(IN PROGRESS)** Fragt, wie mehrere USt-IDs und Bankverbindungen für Constellium ausgewählt werden können, da diese nicht angezeigt werden.
-   3. **(IN PROGRESS)** Gibt Feedback zum Redesign der Vertragspartner-Sektion: zu unübersichtlich, Ansprechpartnerauswahl schlecht, zu viele Infos bei interner Zuständigkeit, zu viel Scrollen. Fordert ein smartes modernes design.
-   2. **(DONE)** Schließt die Implementierung des Nummernkreis-Systems und der Vertragspartner-Erweiterungen ab.
-   1. **(DONE)** Bestätigt den Plan des Agenten, das Nummernkreis-System fertigzustellen.

**Project Health Check:**
-   **Broken:** Keine.
-   **Mocked:** Keine.

**3rd Party Integrations**
-   Zolltarifnummern.de API (v1 & v2)
-   pandas, openpyxl, xlrd
-   EU VIES VAT Validation API
-   country-flag-icons
-   emergentintegrations (OCR)

**Testing status**
-   **Testing agent used after significant changes:** YES
-   **Troubleshoot agent used after agent stuck in loop:** NO
-   **Test files created:**
    -   Der Testing Agent hat in  neue Testfälle generiert und ausgeführt.
-   **Known regressions:** Keine

**Credentials to test flow:**
-   **Admin-Benutzer:**  / 
-   **Test-Benutzer (eingeschränkte Rechte):**  / 

**What agent forgot to execute**
-   Der Agent war dabei, die Neugestaltung der Kontrakt-Positionen zu beginnen. Es wurde ein Backend-Endpunkt erstellt, aber die gesamte Frontend-Arbeit (neuer Dialog, neue Listenansicht, Artikelauswahl-Komponente) steht noch aus und ist die unmittelbare nächste Aufgabe.</analysis>
